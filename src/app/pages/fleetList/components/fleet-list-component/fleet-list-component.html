<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-6 space-y-6 max-w-7xl mx-auto">
  <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-500">
      Battery Fleet
    </h2>
    <button
      pButton
      label="Add Battery"
      icon="pi pi-plus"
      class="p-button-success w-full sm:w-auto px-5 py-2 rounded-lg shadow hover:shadow-md transition"
      (click)="openNewBatteryDialog()"
    ></button>
  </div>

  <div class="flex items-center gap-2">
    <div class="relative w-full sm:max-w-sm">
      <i class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      <input
        pInputText
        type="text"
        placeholder="Search batteries..."
        class="pl-10 pr-3 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-400"
        (input)="onGlobalFilter($event)"
      />
    </div>
  </div>

  <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-md">
    <p-table
      #batteryTable
      [value]="(batteries$ | async) ?? []"
      [paginator]="true"
      [rows]="rows"
      [globalFilterFields]="[
        'id',
        'nominalVoltage',
        'nominalCapacity',
        'nominalEnergy',
        'createdAt'
      ]"
      [stripedRows]="true"
      [rowHover]="true"
      [showGridlines]="false"
      responsiveLayout="scroll"
    >
      <ng-template pTemplate="header">
        <tr class="bg-gray-100 text-gray-700">
          <th class="py-3 px-3 text-left" pSortableColumn="id">
            ID <p-sortIcon field="id"></p-sortIcon>
          </th>
          <th class="py-3 px-3 text-left" pSortableColumn="createdAt">
            Created At <p-sortIcon field="createdAt"></p-sortIcon>
          </th>
          <th class="py-3 px-3 text-left" pSortableColumn="nominalVoltage">
            Voltage (V) <p-sortIcon field="nominalVoltage"></p-sortIcon>
          </th>
          <th class="py-3 px-3 text-left" pSortableColumn="nominalCapacity">
            Capacity (Ah) <p-sortIcon field="nominalCapacity"></p-sortIcon>
          </th>
          <th class="py-3 px-3 text-left" pSortableColumn="nominalEnergy">
            Energy (Wh) <p-sortIcon field="nominalEnergy"></p-sortIcon>
          </th>
          <th class="py-3 px-3 text-left">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-battery>
        <tr
          class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30 transition text-sm sm:text-base"
          (click)="goToDetails(battery.id)"
        >
          <td class="py-2 px-3">{{ battery.id }}</td>
          <td class="py-2 px-3">{{ battery.createdAt | date: 'short' }}</td>
          <td class="py-2 px-3">{{ battery.nominalVoltage }}</td>
          <td class="py-2 px-3">{{ battery.nominalCapacity }}</td>
          <td class="py-2 px-3">{{ battery.nominalEnergy }}</td>
          <td class="py-2 px-3 flex gap-2 justify-start">
            <button
              pButton
              icon="pi pi-pencil"
              class="p-button-rounded p-button-info p-button-sm"
              (click)="editBattery(battery); $event.stopPropagation()"
            ></button>
            <button
              pButton
              icon="pi pi-trash"
              class="p-button-rounded p-button-danger p-button-sm"
              (click)="confirmDeleteBattery(battery.id); $event.stopPropagation()"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="paginatorleft">
        <span class="text-gray-500 text-sm">Rows per page:</span>
      </ng-template>

      <ng-template pTemplate="paginatorright">
        <p-select
          [options]="rowsOptions"
          [(ngModel)]="rows"
          (onChange)="onRowsPerPageChange($event.value, batteryTable)"
          [appendTo]="'body'"
          class="w-28"
          placeholder="Rows"
        ></p-select>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center text-gray-400 py-4">
            No batteries found.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog
    header="{{ isEditMode ? 'Update Battery' : 'Add New Battery' }}"
    [(visible)]="displayDialog"
    [modal]="true"
    [closable]="true"
    [style]="{ width: '90%', maxWidth: '420px' }"
  >
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Nominal Voltage (V)
        </label>
        <input
          pInputText
          type="number"
          [(ngModel)]="batteryForm.nominalVoltage"
          class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-400 px-3 py-2"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Nominal Capacity (Ah)
        </label>
        <input
          pInputText
          type="number"
          [(ngModel)]="batteryForm.nominalCapacity"
          class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-400 px-3 py-2"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Nominal Energy (Wh)
        </label>
        <input
          pInputText
          type="number"
          [(ngModel)]="batteryForm.nominalEnergy"
          class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-400 px-3 py-2"
        />
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex justify-between items-center mt-2 w-full">
        <button
          pButton
          label="Cancel"
          icon="pi pi-times"
          class="p-button-text"
          (click)="closeDialog()"
        ></button>
        <button
          pButton
          label="{{ isEditMode ? 'Update' : 'Create' }}"
          icon="pi pi-check"
          class="p-button-success"
          (click)="saveBattery()"
        ></button>
      </div>
    </ng-template>
  </p-dialog>
</div>
